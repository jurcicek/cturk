<wiki:comment>
This text is using the Google Code wiki syntax.
</wiki:comment>

= INSTALATION MANUAL FOR THE CTURK PROJECT = 

AUTHOR: FILIP JURCICEK

VERSION: 22/07/2011

= INTRODUCTION =

This document describes how to download the code, configure the computer used for deployment, 
installing all necessary software, and runing the CTURK project.

This manual will describe a specific case of installing the CTURK on the Ubuntu 11.04 Linux distribution.

= INSTALLING THE REQUIERED SOFTWARE =

This secstion will describe how to install all necessary software on the Ubuntu 11.04 Linux 
distribution. You will have to have root rights, e.g. to be in the sudo group. The resto of 
the section assumes that you are logged in the root. This can be achieved by running 
the "sudo -s" command from the command line.

If you do not have SVN (Subversion) then it can be installed by the following command:
- apt-get install subversion

You will have to install apache and mysql:
- apt-get install apache2
- apt-get install mysql-server 


FIXME: add all the necesary software


= CHECK OUT THE CODE FROM GOOGLE CODE =

If you plan to make changes, use this command to check out the code as yourself using HTTPS:

# Project members authenticate over HTTPS to allow committing changes.
svn checkout https://cturk.googlecode.com/svn/trunk/ gcturk --username xxx@xxx.com

When prompted, enter your generated googlecode.com password.
Use this command to anonymously check out the latest project source code:

# Non-members may check out a read-only working copy anonymously over HTTP.
svn checkout http://cturk.googlecode.com/svn/trunk/ gcturk-read-only

This manual assumes that the code has been checked out into the "~/src/" directory!


= CONFIGURE THE CTURK = 

The deployment of CTURK assumes deployment of into the public_html direcotory as it allows multiple 
users to deploy CTURK on the same computer in a conroled way.

In this task, we will assume deployment of the computer with the domain name localhost into 
the public_html directory of the "filip" user. 

SUMMARY:
- the code is placed in: /home/filip/public_html/gcturk
- the corresponding URL is: http://localhost/~filip/gcturk
- the web service URL: http://localhost/~filip/gcturk/cturk/server/webroot

Since the code in the src directory, one has to link from the public_html diretory to the gcturk directory
- cd ~/src
- ln -s gcturk ~/public_html


A convenient way to configure CTURK is to use the "switch2config" tool in the cturk directory.
The tool copies all necessary config files into the approriate places. 

It is used as:
- switch2config path_to_the_config_dir
where the path_to_the_config_dir parameters point to the paremters contains all config files for 
setting the CTURK.

Templates of the configuration files are in the "config" directory.

The files that have to be changed are:
- app_conroller.php  - will be coppied to ./server/
- database.php - will be coppied to ./server/config/
- .htaccess - will be coppied to ./server/webroot/
- index.php - will be coppied to ./server/webroot/
- Config.js - will be coppied to ./client/static/js/ui1/

It is advised to make a copy of the config directory using:
- cp -r config config.filip@localhost

then edit the files in config.filip@localhost

== edit app_controller.php ==

Change the following lines:
 
        var $SMTP_SERVER = 'smtp.zzz.com';
        var $SMTP_PORT = '25';
        var $SMTP_TIMEOUT = '30';
        var $SMTP_EMAIL = 'zzzzz_noreply@zzz.com';
        var $SMTP_USERNAME = 'zzzzz_noreply';
        var $SMTP_PASSWORD = 'zzzzzzzzzzzzzz';

to a valid SMTP mail server is sending email is reqiered.

Change PAYPAL_* variables for proper integration with PayPal: 
        var $PAYPAL_APPLICATION_ID = 'APP-zzzzzzzzzzzzzzzzz';
        var $PAYPAL_API_EMAIL = 'zzzzz.zzzzzzz@zzzzz.com';
        var $PAYPAL_API_USERNAME = 'zzzzz.zzzzzzz_api1.zzzzz.com';
        var $PAYPAL_API_PASSWORD = 'zzzzzzzzzzzzzzzz';
        var $PAYPAL_API_SIGNATURE = 'zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz';
        var $PAYPAL_API_ENDPOINT = 'https://svcs.paypal.com/';
        var $PAYPAL_REDIRECT_URL = 'https://www.paypal.com/webscr&cmd=';

The integration with PayPal will be described later.


Change the lines: 
        var $RESET_PASSWORD_LINK = 'http://www.zzzzzzz.org/~zzzzz/zzzzzzzzzzz/cturk/client/resetPassword.html';
        var $PAY_RETURN_LINK = 'http://www.zzzzzzz.org/~zzzzz/zzzzzzzzzzz/cturk/client/requester/index.html';

to:
        var $RESET_PASSWORD_LINK = 'http://localhost/~filip/gcturk/cturk/client/resetPassword.html';
        var $PAY_RETURN_LINK = 'http://localhost/~filip/gcturk/cturk/client/requester/index.html';


Change the $CURRENCY_CODE if different the cturk should a different currency with PayPal.

        var $CURRENCY_CODE = 'GBP'; //USD, GBP, EUR, JPY, CAD, AUD


== edit database.php ==

Change the database information: login, password, database, and prefix.

The prefix is used for all names of tables used by CTURK in the provided database.

<?php
class DATABASE_CONFIG {

        var $default = array(
                'driver' => 'mysql',
                'persistent' => false,
                'host' => 'localhost',
                'login' => 'zzzzz',
                'password' => 'zzzzzzz',
                'database' => 'zzzzz',
                'prefix' => 'zzzzzz_',
                'encoding' => 'utf8'
        );
}
?>



== edit .htaccess ==

Define for the rewrite rules where teh code is located.

Change the line:
	RewriteBase /~zzzzz/zzzzzzzzzzz/cturk/server/webroot 
to:
	RewriteBase /~filip/gcturk/cturk/server/webroot




== edit index.php ==

In the index.php file must be changed the aboslute path to the CakePHP framawork: CAKE_CORE_INCLUDE_PATH
Note that CAKE_CORE_INCLUDE_PATH defines location of the CakePHP framework.

Change the line: 
{{{
	define('CAKE_CORE_INCLUDE_PATH', DS . 'home' . DS . 'zzz' . DS . 'public_html' . DS . 'zzzzzz' . DS . 'cturk' . DS . 'CakePHP');
}}}
to:
{{{
	define('CAKE_CORE_INCLUDE_PATH', DS . 'home' . DS . 'filip' . DS . 'public_html' . DS . 'gcturk' . DS . 'cturk' . DS . 'CakePHP');
}}}	

== edit Config.js ==

The Config.js define the URL where all webservisces used by Javascript are located.

Change the line:
	ajaxUrlPrefix: "/~zzzzz/zzzzzzzzzzz/cturk/server/webroot",
to:
	ajaxUrlPrefix: "/~filip/gcturk/cturk/server/webroot",




Then use the switch2config tool in the cturk directory:
- switch2config ../config.filip@localhost




In addition to copying the config files, the switch2config also sets correct access rights to some directories:
	* Assign all read and write rights to cturk/server/tmp
		chmod -R 777 cturk/server/tmp/

	* Assign mod 755 to cturk/server/webroot
		chmod -R 755 cturk/server/webroot/



= CONFIGURE THE CTURK-TRANSCRIBER =

= PING'S documentation = 

========================================
1. Deploy cturk-task4 from spetechcular.com aid201004 SVN repository
========================================
Targeting folder: /home/ping/public_html/cturk-task4
Correspondong HTTP URL: http://camdial.org/~ping/cturk-task4
Web service URL: http://camdial.org/~ping-cturk4-server/

* Enter the targeting folder
cd /home/ping/public_html/cturk-task4

* Checkout source codes
svn co https://spetechcular.com/svn/aid201004/branches/task4 .

* Set up Apache
Start rewrite module and set
	Options FollowSymLinks MultiViews
	AllowOverride All
	
XXXXXXXX
XXXXXXXX

* Setup Database, using SQL scripts finding @ docs/cturk20101231.sql
(Note: All CakePHP databases start with cturk4_)

* Setup Database parameters
edit cturk/server/config/database.php
(Note: Having the following user)
	user_type registered_email password
	requester midfar@qq.com  admin
	requester admin@midfar.com  admin
	worker midfar@vip.qq.com  admin

* Setup application parameters
edit cturk/server/app_controller.php
Including: SMTP mail server settings, Paypal API settings, and Page redirection settings
(Note: $RESET_PASSWORD_LINK is the HTML page for resetting password, appearing in the mail to reset the password.)
(Note: $PAY_RETURN_LINK is the redirection page when PayPal payment accomplished.)

* edit cturk/client/static/js/ui1/Config.js and cturk/client/form/static/js/Config.js
	ajaxUrlPrefix: "/~ping/cturk-task4/cturk/server/webroot"
(Note: ajaxUrlPrefix is the Web service URL, without host)


* edit 
/cturk/client/form/worker/externalSubmit
/cturk-transcriber/wwwroot/start.html
/cturk-transcriber/wwwroot/start2.html

	<form id="dynamicTableForm" method="POST" action="http://camdial.org/~ping/cturk-task4/cturk/server/webroot/workers/externalSubmit">

* Edit cturk/server/webroot/.htaccess
Add the following:
	RewriteBase /~ping/cturk-task4/cturk/server/webroot
So .htaccess should look like:

	<IfModule mod_rewrite.c>
	  RewriteEngine On
	  RewriteBase /~ping/cturk-task4/cturk/server/webroot
	  RewriteCond %{REQUEST_FILENAME} !-d
	  RewriteCond %{REQUEST_FILENAME} !-f
	  RewriteRule ^(.*)$ index.php?url=$1 [QSA,L]
	</IfModule>

* You need to restart apache at the point
	sudo /etc/init.d/apache2 restart

* visit the following address, you should see the configuration page of CakePHP, but without css styled.
	http://camdial.org/~ping/cturk-task4/cturk/server/webroot 


* Access CTurk application @ http://camdial.org/~ping/cturk-task4/cturk/client/

========================================
2. Requester publishes HITs to CTurk
========================================
* Manually publish HITs (for testing)
Log in to CTurk as requester @ http://camdial.org/~ping/cturk-task4/cturk/client/
Access: http://camdial.org/~ping/cturk-task4/cturk/client/form/requester/createHIT.html
(Note: Firebug (for Firefox ) console prints out "Create a new hit success.")

* Using PERL scripts to publish HITs
In total we need to make changes to 4 files for cturk-transcriber. For easy deply to camdial~ping:
	cd /cturk-transcriber
	bash switch2ping

Detailed changes as the following:

cd /cturk-transcriber/docs

edit config.xml
	  <username>admin@midfar.com</username>
        <password>admin</password>
        <webServiceUrl>http://localhost/~ping/cturk-task4/cturk/server/webroot</webServiceUrl>
        <resourceRoot>/home/ping/public_html/cturk-task4/cturk-transcriber/resources</resourceRoot>
        <webappRoot>/home/ping/public_html/cturk-task4/cturk-transcriber/wwwroot</webappRoot>
        <webappUrl>http://camdial.org/~ping/cturk-task4/cturk-transcriber/wwwroot</webappUrl>
        <transcriptionPrice>0.04</transcriptionPrice>
        <validationPrice>4</validationPrice>
        <mysql>
                <dbHost>localhost</dbHost>
                <dbName>cturk</dbName>
                <dbUser>cturk</dbUser>
                <dbPwd>lccturk</dbPwd>
                <dbPort>3306</dbPort>
                <dbPrefix>cturk_</dbPrefix>
        </mysql>

(Note: camdial does not allow visiting itself from the public domain, so webServiceUrl is set to http://localhost/~ping/cturk-task4/cturk/server/webroot)	

edit cturk-transcriber/wwwroot/start.html and cturk-transcriber/wwwroot/start.html/start2.html
	<form id="dynamicTableForm" method="POST" action="/~ping/cturk-task4/cturk/server/webroot/workers/externalSubmit">

for the first usage, edit cturk-transcriber/docs/publish.sh
	WEB_ROOT="/home/ping/public_html/cturk-task4/cturk-transcriber/wwwroot";
	DOC_ROOT="/home/ping/public_html/cturk-task4/cturk-transcriber/docs";
(Note: WEB_ROOT is cturk-transcriber's wwwroot path. DOC_ROOT is cturk-transcriber's doc path)

Publish HITs
	bash publish.sh $1 $2
(Note: $1 is the folder contains audio files to be transcribed. $3 is the folder contains the standard transcribes. e.g.:)
	bash publish.sh /home/ping/public_html/cturk-task4/cturk-transcriber/resources/wav/raw_100812/ /home/ping/public_html/cturk-task4/cturk-transcriber/resources/wav/ref_100812/
(Note: Every published HIT is assigned to HITGroups according to some same properties. Every HIT has none or multiple assignments.)

========================================
3. Worker accomplishes HITs on CTurk
workerÔÚCturkÍê³ÉHITµÄÁ÷³Ì
========================================
Visit http://camdial.org/~ping/cturk-task4/cturk/client/
Log in as a Worker
Click HITs menu
Click View a HIT in this group
Click Accept HIT to accomplish HITs
Click Accepted HITs to see the full list of accepted but yet submitted HITs

========================================
4. Requester checks HITs
========================================
Log in CTurk as requester
Click Assignments Menu



